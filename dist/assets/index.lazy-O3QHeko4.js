import{r as u,j as e,W as Z,b as K,X as G,Y as he,B as F,Z as ee,_ as Q,ao as $,aq as U,z as a,a1 as se,a2 as B,e as ue,t as me,n as X,a3 as te,a4 as ne,a5 as ae,a6 as ie,a7 as le,F as xe,C as ge,at as je,g as R,h as H,i as E,k as P,I as re,l as z,S as D,s as M,v as V,w as I,x as g,aa as ce,o as _,ad as pe,ae as be,af as fe,ag as ve,ah as ye,ai as Ce,aj as A,ak as Te,al as we,am as W,p as ke,H as Ne,E as Se,T as _e,J as Fe,M as De,c as Me}from"./index-CJ1AcNxb.js";import{u as Ve,D as Ie,I as Ke,M as Le,C as qe,a as Re,f as J,b as He,g as Ee,c as Pe,d as ze,e as Xe,h as Oe,i as Ae}from"./index-BcGaQFY_.js";import{I as Be}from"./IconEdit-DyWwXMJq.js";import{T as Qe}from"./textarea-CMQ2mNcv.js";const oe=Z.createContext(null);function $e({children:s}){const[t,n]=Ve(null),[l,m]=u.useState(null),[p,o]=u.useState(null);return e.jsx(oe.Provider,{value:{open:t,setOpen:n,currentRow:l,setCurrentRow:m,currentRowIndex:p,setCurrentRowIndex:o},children:s})}const O=()=>{const s=Z.useContext(oe);if(!s)throw new Error("useTicket has to be used within <TicketContext>");return s};function Ue({row:s}){const{setOpen:t,setCurrentRow:n}=O(),{user:l}=K(),m=(l==null?void 0:l.role)||"customer",p=["admin","owner","employee"].includes(m);return e.jsxs(G,{modal:!1,children:[e.jsx(he,{asChild:!0,children:e.jsxs(F,{variant:"ghost",className:"flex h-8 w-8 p-0 data-[state=open]:bg-muted",children:[e.jsx(Ie,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Open menu"})]})}),e.jsx(ee,{align:"end",className:"w-[160px]",children:p&&e.jsxs(e.Fragment,{children:[s.original.status!=="closed"&&e.jsxs(Q,{onClick:()=>{n(s.original),t("edit")},children:["Chỉnh sửa",e.jsx($,{children:e.jsx(Be,{size:16})})]}),e.jsxs(Q,{onClick:()=>{n(s.original),t("delete")},className:"!text-red-500",children:["Xóa",e.jsx($,{children:e.jsx(Ke,{size:16})})]})]})})]})}const We=[{accessorKey:"id",header:"ID",meta:{className:"w-[80px]"},enableHiding:!1,enableColumnFilter:!1},{accessorKey:"subject",header:"Tiêu đề",meta:{className:"w-[200px]"}},{accessorKey:"description",header:"Mô tả",meta:{className:"w-[300px]"}},{accessorKey:"priority",header:"Ưu tiên",cell:({row:s})=>{const t={low:"Thấp",medium:"Trung bình",high:"Cao"}[s.getValue("priority")]||"Không xác định",n=s.getValue("priority"),l=n==="low"?"outline":n==="medium"?"default":"destructive";return e.jsx(U,{variant:l,children:t})},meta:{className:"w-[120px]"}},{accessorKey:"status",header:"Trạng thái",cell:({row:s})=>{const t={open:"Mở",in_progress:"Đang xử lý",resolved:"Đã giải quyết",closed:"Đã đóng"}[s.getValue("status")]||"Không xác định",n=s.getValue("status"),l=n==="open"?"default":n==="in_progress"?"secondary":"outline";return e.jsx(U,{variant:l,children:t})},meta:{className:"w-[120px]"}},{accessorKey:"room_name",header:"Phòng",meta:{className:"w-[150px]"}},{accessorKey:"user_name",header:"Khách hàng",meta:{className:"w-[150px]"},enableHiding:!0,enableColumnFilter:!1},{accessorKey:"branch_name",header:"Chi nhánh",meta:{className:"w-[150px]"},enableHiding:!0,enableColumnFilter:!1},{accessorKey:"created_at",header:"Ngày tạo",cell:({row:s})=>new Date(s.getValue("created_at")).toLocaleDateString("vi-VN"),meta:{className:"w-[120px]"},enableHiding:!1,enableColumnFilter:!1},{id:"actions",cell:({row:s})=>e.jsx(Ue,{row:s}),meta:{className:"w-[80px]"}}];a.object({id:a.number(),subject:a.string().min(1,"Vui lòng nhập tiêu đề"),description:a.string().min(1,"Vui lòng nhập mô tả"),priority:a.enum(["low","medium","high"]),status:a.enum(["open","in_progress","resolved","closed"]),created_at:a.string(),room_name:a.string(),room_id:a.number().min(1,"Vui lòng chọn phòng").optional(),user_id:a.number().optional(),user_name:a.string().optional(),branch_id:a.number().optional(),branch_name:a.string().optional()});const de=a.object({id:a.number().optional(),subject:a.string().min(1,"Vui lòng nhập tiêu đề"),description:a.string().min(1,"Vui lòng nhập mô tả"),priority:a.enum(["low","medium","high"]),status:a.enum(["open","in_progress","resolved","closed"]).optional(),room_id:a.number().min(1,"Vui lòng chọn phòng"),user_id:a.number().optional(),branch_id:a.number().optional()});a.array(de);a.object({status:a.enum(["open","in_progress","resolved","closed"]).optional(),priority:a.enum(["low","medium","high"]).optional()});a.object({total_tickets:a.number(),open_tickets:a.number(),in_progress_tickets:a.number(),resolved_tickets:a.number(),closed_tickets:a.number()});function Y({currentRow:s,open:t,onOpenChange:n,page:l,limit:m,search:p,status:o="",priority:j="",branchId:d=0}){const r=!!(s!=null&&s.id),C=se(),{user:b}=K(),h=(b==null?void 0:b.role)||"customer",f=Number(b==null?void 0:b.id)||0,{data:v,isLoading:T,error:w}=B({queryKey:["rooms-for-tickets",f,h,d],queryFn:()=>_.getAllRooms({page:1,limit:100}),enabled:t,staleTime:5*60*1e3}),y=(v==null?void 0:v.data)||[],x=ue({resolver:me(de),defaultValues:r?{id:s.id,subject:s.subject,description:s.description,priority:s.priority,status:s.status,room_id:s.room_id,user_id:s.user_id,branch_id:s.branch_id}:{subject:"",description:"",priority:"medium",room_id:void 0,user_id:f,branch_id:d}});u.useEffect(()=>{!r&&y.length>0&&!x.getValues("room_id")&&x.setValue("room_id",y[0].id)},[y,r,x]),u.useEffect(()=>{t||x.reset()},[t,x]);const S=async c=>{var i,L;try{if(r){if(!(s!=null&&s.id))throw new Error("Ticket ID is missing");await _.updateTicket(s.id,{status:c.status,priority:c.priority})}else await _.createTicket(c);C.invalidateQueries({queryKey:["tickets",l,m,p,o,j,d,h,f]}),X({title:r?"Cập nhật thành công!":"Tạo ticket thành công!"}),n(!1)}catch(N){const k=((L=(i=N.response)==null?void 0:i.data)==null?void 0:L.message)||N.message||"Lỗi hệ thống, vui lòng thử lại sau";X({title:r?"Cập nhật thất bại":"Tạo ticket thất bại",description:k,variant:"destructive"})}};return w?(X({variant:"destructive",title:"Lỗi khi tải danh sách phòng",description:"Không thể tải danh sách phòng, vui lòng thử lại sau."}),n(!1),null):e.jsx(te,{open:t,onOpenChange:n,children:e.jsxs(ne,{className:"sm:max-w-lg",children:[e.jsxs(ae,{children:[e.jsx(ie,{children:r?"Chỉnh sửa Ticket":"Thêm Ticket Mới"}),e.jsxs(le,{children:[r?"Cập nhật thông tin ticket.":"Tạo yêu cầu hỗ trợ mới."," ","Nhấn Xác nhận khi hoàn tất."]})]}),e.jsx(xe,{...x,children:e.jsxs("form",{onSubmit:x.handleSubmit(S),className:"space-y-4",children:[e.jsx(ge,{children:e.jsxs(je,{className:"space-y-4 pt-6",children:[e.jsx(R,{control:x.control,name:"subject",render:({field:c})=>e.jsxs(H,{children:[e.jsx(E,{children:"Tiêu đề"}),e.jsx(P,{children:e.jsx(re,{placeholder:"Nhập tiêu đề",...c,disabled:r&&h==="customer"})}),e.jsx(z,{})]})}),e.jsx(R,{control:x.control,name:"description",render:({field:c})=>e.jsxs(H,{children:[e.jsx(E,{children:"Mô tả"}),e.jsx(P,{children:e.jsx(Qe,{placeholder:"Mô tả vấn đề",...c,disabled:r&&h==="customer"})}),e.jsx(z,{})]})}),e.jsx(R,{control:x.control,name:"room_id",render:({field:c})=>e.jsxs(H,{children:[e.jsx(E,{children:"Phòng"}),e.jsx(P,{children:T?e.jsx("div",{children:"Đang tải..."}):y.length===0?e.jsx("div",{className:"text-red-500",children:"Không có phòng nào để chọn"}):e.jsxs(D,{onValueChange:i=>c.onChange(Number(i)),value:c.value?String(c.value):"",disabled:r||h==="customer"&&y.length<=1,children:[e.jsx(M,{children:e.jsx(V,{placeholder:"Chọn phòng"})}),e.jsx(I,{children:y.map(i=>e.jsx(g,{value:String(i.id),children:i.name},i.id))})]})}),e.jsx(z,{})]})}),h!=="customer"&&e.jsxs(e.Fragment,{children:[e.jsx(R,{control:x.control,name:"priority",render:({field:c})=>e.jsxs(H,{children:[e.jsx(E,{children:"Ưu tiên"}),e.jsx(P,{children:e.jsxs(D,{onValueChange:c.onChange,value:c.value,children:[e.jsx(M,{children:e.jsx(V,{placeholder:"Chọn mức độ ưu tiên"})}),e.jsxs(I,{children:[e.jsx(g,{value:"low",children:"Thấp"}),e.jsx(g,{value:"medium",children:"Trung bình"}),e.jsx(g,{value:"high",children:"Cao"})]})]})}),e.jsx(z,{})]})}),e.jsx(R,{control:x.control,name:"status",render:({field:c})=>e.jsxs(H,{children:[e.jsx(E,{children:"Trạng thái"}),e.jsx(P,{children:e.jsxs(D,{onValueChange:c.onChange,value:c.value,children:[e.jsx(M,{children:e.jsx(V,{placeholder:"Chọn trạng thái"})}),e.jsxs(I,{children:[e.jsx(g,{value:"open",children:"Mở"}),e.jsx(g,{value:"in_progress",children:"Đang xử lý"}),e.jsx(g,{value:"resolved",children:"Đã giải quyết"}),e.jsx(g,{value:"closed",children:"Đã đóng"})]})]})}),e.jsx(z,{})]})})]})]})}),e.jsx(ce,{children:e.jsx(F,{type:"submit",disabled:T||y.length===0&&!r,children:"Xác nhận"})})]})})]})})}function Je({open:s,onOpenChange:t,currentRow:n,page:l,limit:m,search:p}){const o=se(),{user:j}=K(),d=(j==null?void 0:j.role)||"customer",r=Number(j==null?void 0:j.id)||0,{setCurrentRow:C}=O(),b=async()=>{var h,f;try{await _.deleteTicket(n.id),o.invalidateQueries({queryKey:["tickets",l,m,p,"","",0,d,r]}),X({title:"Xóa ticket thành công!"}),t(!1),setTimeout(()=>C(null),500)}catch(v){const T=((f=(h=v.response)==null?void 0:h.data)==null?void 0:f.message)||v.message||"Lỗi hệ thống, vui lòng thử lại sau";X({title:"Xóa ticket thất bại",description:T,variant:"destructive"})}};return e.jsx(te,{open:s,onOpenChange:t,children:e.jsxs(ne,{className:"sm:max-w-[425px]",children:[e.jsxs(ae,{children:[e.jsx(ie,{children:"Xóa Ticket"}),e.jsx(le,{children:"Bạn có chắc chắn muốn xóa ticket này? Hành động này không thể hoàn tác."})]}),e.jsxs(ce,{children:[e.jsx(F,{variant:"outline",onClick:()=>t(!1),children:"Hủy"}),e.jsx(F,{variant:"destructive",onClick:b,children:"Xóa"})]})]})})}function Ye({page:s,limit:t,search:n,status:l="",priority:m="",branchId:p=0}){const{open:o,setOpen:j,currentRow:d,setCurrentRow:r}=O();return o?e.jsxs(e.Fragment,{children:[o==="add"&&e.jsx(Y,{open:!0,onOpenChange:()=>j(null),page:s,limit:t,search:n,status:l,priority:m,branchId:p},"ticket-add"),d&&e.jsxs(e.Fragment,{children:[o==="edit"&&e.jsx(Y,{open:!0,onOpenChange:()=>{j(null),setTimeout(()=>r(null),500)},currentRow:d,page:s,limit:t,search:n,status:l,priority:m,branchId:p},`ticket-edit-${d.id}`),o==="delete"&&e.jsx(Je,{open:!0,onOpenChange:()=>{j(null),setTimeout(()=>r(null),500)},currentRow:d,page:s,limit:t,search:n},`ticket-delete-${d.id}`)]})]}):null}function Ze(){const{setOpen:s}=O(),{user:t}=K(),n=(t==null?void 0:t.role)||"customer";return e.jsx("div",{className:"flex items-center space-x-2",children:n==="customer"&&e.jsx(F,{onClick:()=>s("add"),children:"Thêm Ticket"})})}const Ge={name:"Tên chi nhánh",address:"Địa chỉ",phone:"Số điện thoại"};function es({table:s}){return e.jsxs(G,{modal:!1,children:[e.jsx(pe,{asChild:!0,children:e.jsxs(F,{variant:"outline",size:"sm",className:"ml-auto hidden h-8 lg:flex",children:[e.jsx(Le,{className:"mr-2 h-4 w-4"}),"Xem"]})}),e.jsxs(ee,{align:"end",className:"w-[150px]",children:[e.jsx(be,{children:"Hiển thị cột"}),e.jsx(fe,{}),s.getAllColumns().filter(t=>typeof t.accessorFn<"u"&&t.getCanHide()).map(t=>e.jsx(ve,{className:"capitalize",checked:t.getIsVisible(),onCheckedChange:n=>t.toggleVisibility(!!n),children:Ge[t.id]},t.id))]})]})}function ss({table:s,setSearch:t,setStatus:n,setPriority:l,setBranchId:m,branchId:p,search:o,status:j,priority:d}){const{user:r}=K(),C=(r==null?void 0:r.role)||"customer",[b,h]=u.useState(o),[f,v]=u.useState(j||"all"),[T,w]=u.useState(d||"all"),{data:y,isLoading:x}=B({queryKey:["branches-for-filter"],queryFn:()=>_.getAllBranches({page:1,limit:100}),enabled:C!=="customer",staleTime:5*60*1e3}),S=(y==null?void 0:y.data)||[];u.useEffect(()=>{h(o)},[o]),u.useEffect(()=>{const i=setTimeout(()=>{t(b)},500);return()=>clearTimeout(i)},[b,t]),u.useEffect(()=>{n(f==="all"?"":f)},[f,n]),u.useEffect(()=>{l(T==="all"?"":T)},[T,l]);const c=()=>{s.resetColumnFilters(),h(""),v("all"),w("all"),m(0),t(""),n(""),l("")};return e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-2",children:[e.jsx(re,{placeholder:"Tìm kiếm ticket...",value:b,onChange:i=>h(i.target.value),className:"h-8 w-[150px] lg:w-[250px]"}),e.jsxs(D,{onValueChange:i=>v(i),value:f,children:[e.jsx(M,{className:"h-8 w-[150px]",children:e.jsx(V,{placeholder:"Lọc theo trạng thái"})}),e.jsxs(I,{children:[e.jsx(g,{value:"all",children:"Tất cả trạng thái"}),e.jsx(g,{value:"open",children:"Mở"}),e.jsx(g,{value:"in_progress",children:"Đang xử lý"}),e.jsx(g,{value:"resolved",children:"Đã giải quyết"}),e.jsx(g,{value:"closed",children:"Đã đóng"})]})]}),e.jsxs(D,{onValueChange:i=>w(i),value:T,children:[e.jsx(M,{className:"h-8 w-[150px]",children:e.jsx(V,{placeholder:"Lọc theo ưu tiên"})}),e.jsxs(I,{children:[e.jsx(g,{value:"all",children:"Tất cả ưu tiên"}),e.jsx(g,{value:"low",children:"Thấp"}),e.jsx(g,{value:"medium",children:"Trung bình"}),e.jsx(g,{value:"high",children:"Cao"})]})]}),C!=="customer"&&e.jsxs(D,{onValueChange:i=>m(Number(i)),value:String(p),disabled:x,children:[e.jsx(M,{className:"h-8 w-[150px]",children:e.jsx(V,{placeholder:"Lọc theo chi nhánh"})}),e.jsxs(I,{children:[e.jsx(g,{value:"0",children:"Tất cả chi nhánh"}),S.map(i=>e.jsx(g,{value:String(i.id),children:i.name},i.id))]})]}),(s.getState().columnFilters.length>0||b||f!=="all"||T!=="all"||p!==0)&&e.jsxs(F,{variant:"ghost",onClick:c,className:"h-8 px-2 lg:px-3",children:["Reset",e.jsx(qe,{className:"ml-2 h-4 w-4"})]})]}),e.jsx(es,{table:s})]})}function ts({columns:s,data:t,pagination:n,setPage:l,setLimit:m,setSearch:p,setStatus:o,setPriority:j,setBranchId:d,branchId:r,search:C,status:b,priority:h}){var L;const[f,v]=u.useState({}),[T,w]=u.useState({}),[y,x]=u.useState([]),[S,c]=u.useState([]),i=Re({data:t,columns:s,state:{sorting:S,columnVisibility:T,rowSelection:f,columnFilters:y,pagination:{pageIndex:n.current_page-1,pageSize:n.limit}},manualPagination:!0,pageCount:n.total_pages,enableRowSelection:!0,onRowSelectionChange:v,onSortingChange:c,onColumnFiltersChange:x,onColumnVisibilityChange:w,getCoreRowModel:Ae(),getFilteredRowModel:Oe(),getPaginationRowModel:Xe(),getSortedRowModel:ze(),getFacetedRowModel:Pe(),getFacetedUniqueValues:Ee()});return e.jsxs("div",{className:"space-y-4",children:[e.jsx(ss,{table:i,setSearch:p,setStatus:o,setPriority:j,setBranchId:d,branchId:r,search:C,status:b,priority:h}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(ye,{children:[e.jsx(Ce,{children:i.getHeaderGroups().map(N=>e.jsx(A,{className:"group/row",children:N.headers.map(k=>{var q;return e.jsx(Te,{colSpan:k.colSpan,className:((q=k.column.columnDef.meta)==null?void 0:q.className)??"",children:k.isPlaceholder?null:J(k.column.columnDef.header,k.getContext())},k.id)})},N.id))}),e.jsx(we,{children:(L=i.getRowModel().rows)!=null&&L.length?i.getRowModel().rows.map(N=>e.jsx(A,{"data-state":N.getIsSelected()&&"selected",className:"group/row",children:N.getVisibleCells().map(k=>{var q;return e.jsx(W,{className:((q=k.column.columnDef.meta)==null?void 0:q.className)??"",children:J(k.column.columnDef.cell,k.getContext())},k.id)})},N.id)):e.jsx(A,{children:e.jsx(W,{colSpan:s.length,className:"h-24 text-center",children:"Không có kết quả."})})})]})}),e.jsx(He,{table:i,setPage:l,setLimit:m,totalRecords:n.total_records})]})}function ns(){const{toast:s}=ke(),{user:t}=K(),n=(t==null?void 0:t.role)||"customer",l=Number(t==null?void 0:t.id)||0,[m,p]=u.useState(1),[o,j]=u.useState(10),[d,r]=u.useState(""),[C,b]=u.useState(""),[h,f]=u.useState(""),[v,T]=u.useState(0),{data:w,isLoading:y,error:x}=B({queryKey:["tickets",m,o,d,C,h,v,n,l],queryFn:async()=>n==="customer"?await _.getCustomerTickets(l,{page:m,limit:o,search:d,status:C,priority:h}):_.getAllTickets({page:m,limit:o,search:d,status:C,priority:h,branch_id:v}),staleTime:5*60*1e3,retry:2,refetchOnWindowFocus:!1});x&&s({variant:"destructive",title:"Lỗi khi tải danh sách ticket",description:x.message,duration:5e3});const S=(w==null?void 0:w.data.tickets)||[],c=(w==null?void 0:w.pagination)||{current_page:1,limit:10,total_records:0,total_pages:1};return e.jsxs($e,{children:[e.jsxs(Ne,{fixed:!0,children:[e.jsx(Se,{}),e.jsxs("div",{className:"ml-auto flex items-center space-x-4",children:[e.jsx(_e,{}),e.jsx(Fe,{})]})]}),e.jsx(De,{children:y&&!w?e.jsx("div",{className:"flex h-full items-center justify-center",children:"Đang tải danh sách ticket..."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-2 flex flex-wrap items-center justify-between space-y-2",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold tracking-tight",children:"Danh sách Ticket"}),e.jsx("p",{className:"text-muted-foreground",children:"Quản lý các yêu cầu hỗ trợ"})]}),e.jsx(Ze,{})]}),e.jsx("div",{className:"-mx-4 flex-1 overflow-auto px-4 py-1 lg:flex-row lg:space-x-12 lg:space-y-0",children:e.jsx(ts,{data:S,columns:We,pagination:c,setPage:p,setLimit:j,setSearch:r,setStatus:b,setPriority:f,setBranchId:T,branchId:v,search:d,status:C,priority:h})})]})}),e.jsx(Ye,{page:m,limit:o,search:d,status:C,priority:h,branchId:v})]})}const cs=Me("/_authenticated/tickets/")({component:ns});export{cs as Route};
