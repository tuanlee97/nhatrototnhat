import{r as m,j as e,W as ne,b as q,X as te,Y as oe,B as T,Z as ae,_ as J,ao as Z,aq as de,z as i,a1 as ie,a2 as Q,e as ue,t as he,n as F,a3 as z,a4 as X,a5 as A,a6 as O,a7 as Y,F as me,C as ge,at as xe,g as k,h as K,i as L,k as E,S as R,s as V,v as I,w as H,x as w,l as B,aa as le,o as M,ad as pe,ae as je,af as be,ag as fe,I as ye,ah as Ce,ai as Ne,aj as P,ak as we,al as ve,am as G,p as Se,H as _e,E as Me,T as Te,J as De,M as Fe,c as qe}from"./index-j9nM6RGn.js";import{u as Re,D as Ve,I as Ie,M as He,C as ke,a as Ke,f as ee,b as Le,g as Ee,c as Be,d as Pe,e as ze,h as Xe,i as Ae}from"./index-uyHfpxmr.js";import{I as Oe}from"./IconEdit-gCz2Ttuw.js";import{T as Ye}from"./textarea-D7m4DA-0.js";const re=ne.createContext(null);function Qe({children:s}){const[n,t]=Re(null),[o,d]=m.useState(null),[u,x]=m.useState(null);return e.jsx(re,{value:{open:n,setOpen:t,currentRow:o,setCurrentRow:d,currentRowIndex:u,setCurrentRowIndex:x},children:s})}const $=()=>{const s=ne.useContext(re);if(!s)throw new Error("useMaintenance has to be used within <MaintenanceContext>");return s};function $e({row:s}){const{setOpen:n,setCurrentRow:t}=$(),{user:o}=q(),d=(o==null?void 0:o.role)||"customer",u=["admin","owner","employee"].includes(d);return e.jsxs(te,{modal:!1,children:[e.jsx(oe,{asChild:!0,children:e.jsxs(T,{variant:"ghost",className:"flex h-8 w-8 p-0 data-[state=open]:bg-muted",children:[e.jsx(Ve,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Open menu"})]})}),e.jsx(ae,{align:"end",className:"w-[160px]",children:u&&e.jsxs(e.Fragment,{children:[s.original.status==="pending"&&e.jsxs(J,{onClick:()=>{t(s.original),n("edit")},children:["Chỉnh sửa",e.jsx(Z,{children:e.jsx(Oe,{size:16})})]}),e.jsxs(J,{onClick:()=>{t(s.original),n("delete")},className:"!text-red-500",children:["Xóa",e.jsx(Z,{children:e.jsx(Ie,{size:16})})]})]})})]})}const Ue=[{accessorKey:"id",header:"ID",meta:{className:"w-[80px]"},enableHiding:!1,enableColumnFilter:!1},{accessorKey:"description",header:"Mô tả",meta:{className:"w-[300px]"}},{accessorKey:"status",header:"Trạng thái",cell:({row:s})=>{const n={pending:"Đang chờ",in_progress:"Đang xử lý",completed:"Hoàn thành"}[s.getValue("status")]||"Không xác định",t=s.getValue("status"),o=t==="pending"?"default":t==="in_progress"?"secondary":"outline";return e.jsx(de,{variant:o,children:n})},meta:{className:"w-[120px]"}},{accessorKey:"room_name",header:"Phòng",meta:{className:"w-[150px]"}},{accessorKey:"user_name",header:"Khách hàng",meta:{className:"w-[150px]"},enableHiding:!0,enableColumnFilter:!1},{accessorKey:"branch_name",header:"Chi nhánh",meta:{className:"w-[150px]"},enableHiding:!0,enableColumnFilter:!1},{accessorKey:"created_at",header:"Ngày tạo",cell:({row:s})=>new Date(s.getValue("created_at")).toLocaleDateString("vi-VN"),meta:{className:"w-[120px]"},enableHiding:!1,enableColumnFilter:!1},{id:"actions",cell:({row:s})=>e.jsx($e,{row:s}),meta:{className:"w-[80px]"}}];i.object({id:i.number(),description:i.string().min(1,"Vui lòng nhập mô tả"),status:i.enum(["pending","in_progress","completed"]),created_at:i.string(),room_name:i.string(),created_by:i.string().optional(),branch_name:i.string().optional(),room_id:i.number().min(1,"Vui lòng chọn phòng").optional(),user_id:i.number().optional(),branch_id:i.number().optional()});const We=i.object({id:i.number().optional(),status:i.enum(["pending","in_progress","completed"]).optional(),room_id:i.number().min(1,"Vui lòng chọn phòng"),description:i.string().min(1,"Vui lòng nhập mô tả"),user_id:i.number().optional(),branch_id:i.number().optional()});i.object({status:i.enum(["pending","in_progress","completed"])});i.object({total_requests:i.number(),pending_requests:i.number(),in_progress_requests:i.number(),completed_requests:i.number()});function se({currentRow:s,open:n,onOpenChange:t,page:o,limit:d,search:u,status:x="",branchId:l=0}){const a=!!(s!=null&&s.id),C=ie(),{user:h}=q(),p=(h==null?void 0:h.role)||"customer",j=Number(h==null?void 0:h.id)||0,{data:b,isLoading:g,error:_,isFetched:v}=Q({queryKey:["rooms-for-maintenance",j,p,l],queryFn:async()=>M.getAllRooms({page:1,limit:100}),enabled:n,staleTime:5*60*1e3}),r=(b==null?void 0:b.data)||[],[D,N]=m.useState(!1);m.useEffect(()=>{v&&!g&&N(!0)},[v,g]);const y=ue({resolver:he(We),defaultValues:a?{description:s.description,status:s.status||"pending",room_id:s.room_id,user_id:Number(s.created_by),branch_id:s.branch_id}:{description:"",status:"pending",room_id:0,user_id:j,branch_id:l}});m.useEffect(()=>{!a&&r.length>0&&!y.getValues("room_id")&&y.setValue("room_id",r[0].id)},[r,a,y]),m.useEffect(()=>{n||y.reset()},[n,y]);const S=async c=>{var f,U;try{if(a){if(!(s!=null&&s.id))throw new Error("Maintenance Request ID is missing");await M.updateMaintenanceRequest(s.id,{status:c.status||"pending"})}else await M.createMaintenanceRequest(c);C.invalidateQueries({queryKey:["maintenance-requests",o,d,u,x,l,p,j]}),F({title:a?"Cập nhật thành công!":"Tạo yêu cầu bảo trì thành công!"}),t(!1)}catch(W){const ce=((U=(f=W.response)==null?void 0:f.data)==null?void 0:U.message)||W.message||"Lỗi hệ thống, vui lòng thử lại sau";F({title:a?"Cập nhật thất bại":"Tạo yêu cầu bảo trì thất bại",description:ce,variant:"destructive"})}};return _&&(F({title:"Lỗi khi tải danh sách phòng",description:"Không thể tải danh sách phòng, vui lòng thử lại sau.",variant:"destructive"}),t(!1)),!D&&!g&&!a?e.jsx(z,{open:n,onOpenChange:t,children:e.jsx(X,{className:"sm:max-w-lg",children:e.jsxs(A,{className:"text-left",children:[e.jsx(O,{children:"Thêm Yêu cầu Bảo trì mới"}),e.jsx(Y,{children:"Đang chuẩn bị dữ liệu..."})]})})}):e.jsx(z,{open:n,onOpenChange:t,children:e.jsxs(X,{className:"sm:max-w-lg",children:[e.jsxs(A,{className:"text-left",children:[e.jsx(O,{children:a?"Chỉnh sửa Yêu cầu Bảo trì":"Thêm Yêu cầu Bảo trì mới"}),e.jsxs(Y,{children:[a?"Chỉnh sửa yêu cầu bảo trì tại đây.":"Tạo yêu cầu bảo trì mới tại đây."," ","Nhấp vào Xác nhận khi bạn hoàn tất."]})]}),e.jsx(me,{...y,children:e.jsxs("form",{onSubmit:y.handleSubmit(S),className:"space-y-4",children:[e.jsx(ge,{children:e.jsxs(xe,{className:"space-y-2 pt-6",children:[e.jsx(k,{control:y.control,name:"room_id",render:({field:c})=>e.jsxs(K,{className:"grid grid-cols-6 items-center gap-x-4 gap-y-1 space-y-0",children:[e.jsx(L,{className:"col-span-2 text-left",children:"Phòng"}),e.jsx(E,{children:g?e.jsx("div",{className:"col-span-4 flex items-center justify-center",children:e.jsx("span",{children:"Đang tải..."})}):r.length===0?e.jsx("div",{className:"col-span-4 flex items-center justify-center text-red-500",children:"Không có phòng nào để chọn"}):e.jsxs(R,{onValueChange:f=>c.onChange(Number(f)),value:c.value?String(c.value):"",disabled:p==="customer"&&r.length<=1,children:[e.jsx(V,{className:"col-span-4",children:e.jsx(I,{placeholder:"Chọn phòng"})}),e.jsx(H,{children:r.map(f=>e.jsx(w,{value:String(f.id),children:f.name},f.id))})]})}),e.jsx(B,{className:"col-span-4 col-start-3"})]})}),e.jsx(k,{control:y.control,name:"description",render:({field:c})=>e.jsxs(K,{className:"grid grid-cols-6 items-center gap-x-4 gap-y-1 space-y-0",children:[e.jsx(L,{className:"col-span-2 text-left",children:"Mô tả"}),e.jsx(E,{children:e.jsx(Ye,{placeholder:"Mô tả vấn đề",className:"col-span-4",...c})}),e.jsx(B,{className:"col-span-4 col-start-3"})]})}),p!=="customer"&&e.jsx(k,{control:y.control,name:"status",render:({field:c})=>e.jsxs(K,{className:"grid grid-cols-6 items-center gap-x-4 gap-y-1 space-y-0",children:[e.jsx(L,{className:"col-span-2 text-left",children:"Trạng thái"}),e.jsx(E,{children:e.jsxs(R,{onValueChange:c.onChange,value:c.value||"pending",children:[e.jsx(V,{className:"col-span-4",children:e.jsx(I,{placeholder:"Chọn trạng thái"})}),e.jsxs(H,{children:[e.jsx(w,{value:"pending",children:"Đang chờ"}),e.jsx(w,{value:"in_progress",children:"Đang xử lý"}),e.jsx(w,{value:"completed",children:"Hoàn thành"})]})]})}),e.jsx(B,{className:"col-span-4 col-start-3"})]})})]})}),e.jsx(le,{children:e.jsx(T,{type:"submit",disabled:g||r.length===0,children:"Xác nhận"})})]})})]})})}function Je({currentRow:s,open:n,onOpenChange:t,page:o,limit:d,search:u}){const x=ie(),{user:l}=q(),a=(l==null?void 0:l.role)||"customer",C=Number(l==null?void 0:l.id)||0,h=async()=>{var p,j;try{await M.deleteMaintenanceRequest(s.id),x.invalidateQueries({queryKey:["maintenance-requests",o,d,u,a,C]}),F({title:"Xóa yêu cầu bảo trì thành công!"}),t(!1)}catch(b){const g=((j=(p=b.response)==null?void 0:p.data)==null?void 0:j.message)||b.message||"Lỗi hệ thống, vui lòng thử lại sau";F({title:"Xóa yêu cầu bảo trì thất bại",description:g,variant:"destructive"})}};return e.jsx(z,{open:n,onOpenChange:t,children:e.jsxs(X,{children:[e.jsxs(A,{children:[e.jsx(O,{children:"Xóa Yêu cầu Bảo trì"}),e.jsxs(Y,{children:['Bạn có chắc chắn muốn xóa yêu cầu bảo trì "',s.description,'"? Hành động này không thể hoàn tác.']})]}),e.jsxs(le,{children:[e.jsx(T,{variant:"outline",onClick:()=>t(!1),children:"Hủy"}),e.jsx(T,{variant:"destructive",onClick:h,children:"Xóa"})]})]})})}function Ze({page:s,limit:n,search:t,status:o="",branchId:d=0}){const{open:u,setOpen:x,currentRow:l,setCurrentRow:a}=$();return u?e.jsxs(e.Fragment,{children:[u==="add"&&e.jsx(se,{open:!0,onOpenChange:()=>x(null),page:s,limit:n,search:t,status:o,branchId:d},"maintenance-add"),l&&e.jsxs(e.Fragment,{children:[u==="edit"&&e.jsx(se,{open:!0,onOpenChange:()=>{x(null),setTimeout(()=>a(null),500)},currentRow:l,page:s,limit:n,search:t,status:o,branchId:d},`maintenance-edit-${l.id}`),u==="delete"&&e.jsx(Je,{open:!0,onOpenChange:()=>{x(null),setTimeout(()=>a(null),500)},currentRow:l,page:s,limit:n,search:t},`maintenance-delete-${l.id}`)]})]}):null}function Ge(){const{setOpen:s}=$();return e.jsx(T,{onClick:()=>s("add"),children:"Thêm Yêu cầu Bảo trì"})}const es={description:"Mô tả",status:"Trạng thái",room_name:"Phòng",user_name:"Khách hàng",branch_name:"Chi nhánh"};function ss({table:s}){return e.jsxs(te,{modal:!1,children:[e.jsx(pe,{asChild:!0,children:e.jsxs(T,{variant:"outline",size:"sm",className:"ml-auto hidden h-8 lg:flex",children:[e.jsx(He,{className:"mr-2 h-4 w-4"}),"Xem"]})}),e.jsxs(ae,{align:"end",className:"w-[150px]",children:[e.jsx(je,{children:"Hiển thị cột"}),e.jsx(be,{}),s.getAllColumns().filter(n=>typeof n.accessorFn<"u"&&n.getCanHide()).map(n=>e.jsx(fe,{className:"capitalize",checked:n.getIsVisible(),onCheckedChange:t=>n.toggleVisibility(!!t),children:es[n.id]},n.id))]})]})}function ns({table:s,setSearch:n,setStatus:t,setBranchId:o,branchId:d,search:u,status:x}){const{user:l}=q(),a=(l==null?void 0:l.role)||"customer",[C,h]=m.useState(u),[p,j]=m.useState(x||"all"),{data:b,isLoading:g}=Q({queryKey:["branches-for-filter"],queryFn:()=>M.getAllBranches({page:1,limit:100}),enabled:a!=="customer",staleTime:5*60*1e3}),_=(b==null?void 0:b.data)||[];m.useEffect(()=>{h(u)},[u]),m.useEffect(()=>{const r=setTimeout(()=>{n(C)},500);return()=>clearTimeout(r)},[C,n]),m.useEffect(()=>{t(p==="all"?"":p)},[p,t]);const v=()=>{s.resetColumnFilters(),h(""),j("all"),o(0),n(""),t("")};return e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex flex-1 items-center space-x-2",children:[e.jsx(ye,{placeholder:"Tìm kiếm yêu cầu bảo trì...",value:C,onChange:r=>h(r.target.value),className:"h-8 w-[150px] lg:w-[250px]"}),e.jsxs(R,{onValueChange:r=>j(r),value:p,children:[e.jsx(V,{className:"h-8 w-[150px]",children:e.jsx(I,{placeholder:"Lọc theo trạng thái"})}),e.jsxs(H,{children:[e.jsx(w,{value:"all",children:"Tất cả trạng thái"}),e.jsx(w,{value:"pending",children:"Đang chờ"}),e.jsx(w,{value:"in_progress",children:"Đang xử lý"}),e.jsx(w,{value:"completed",children:"Hoàn thành"})]})]}),a!=="customer"&&e.jsxs(R,{onValueChange:r=>{o(Number(r))},value:String(d),disabled:g,children:[e.jsx(V,{className:"h-8 w-[150px]",children:e.jsx(I,{placeholder:"Lọc theo chi nhánh"})}),e.jsxs(H,{children:[e.jsx(w,{value:"0",children:"Tất cả chi nhánh"}),_.map(r=>e.jsx(w,{value:String(r.id),children:r.name},r.id))]})]}),(s.getState().columnFilters.length>0||C||p!=="all"||d!==0)&&e.jsxs(T,{variant:"ghost",onClick:v,className:"h-8 px-2 lg:px-3",children:["Reset",e.jsx(ke,{className:"ml-2 h-4 w-4"})]})]}),e.jsx(ss,{table:s})]})}function ts({columns:s,data:n,pagination:t,setPage:o,setLimit:d,setSearch:u,setStatus:x,setBranchId:l,branchId:a,search:C,status:h}){var y;const[p,j]=m.useState({}),[b,g]=m.useState({}),[_,v]=m.useState([]),[r,D]=m.useState([]),N=Ke({data:n,columns:s,state:{sorting:r,columnVisibility:b,rowSelection:p,columnFilters:_,pagination:{pageIndex:t.current_page-1,pageSize:t.limit}},manualPagination:!0,pageCount:t.total_pages,enableRowSelection:!0,onRowSelectionChange:j,onSortingChange:D,onColumnFiltersChange:v,onColumnVisibilityChange:g,getCoreRowModel:Ae(),getFilteredRowModel:Xe(),getPaginationRowModel:ze(),getSortedRowModel:Pe(),getFacetedRowModel:Be(),getFacetedUniqueValues:Ee()});return e.jsxs("div",{className:"space-y-4",children:[e.jsx(ns,{table:N,setSearch:u,setStatus:x,setBranchId:l,branchId:a,search:C,status:h}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(Ce,{children:[e.jsx(Ne,{children:N.getHeaderGroups().map(S=>e.jsx(P,{className:"group/row",children:S.headers.map(c=>{var f;return e.jsx(we,{colSpan:c.colSpan,className:((f=c.column.columnDef.meta)==null?void 0:f.className)??"",children:c.isPlaceholder?null:ee(c.column.columnDef.header,c.getContext())},c.id)})},S.id))}),e.jsx(ve,{children:(y=N.getRowModel().rows)!=null&&y.length?N.getRowModel().rows.map(S=>e.jsx(P,{"data-state":S.getIsSelected()&&"selected",className:"group/row",children:S.getVisibleCells().map(c=>{var f;return e.jsx(G,{className:((f=c.column.columnDef.meta)==null?void 0:f.className)??"",children:ee(c.column.columnDef.cell,c.getContext())},c.id)})},S.id)):e.jsx(P,{children:e.jsx(G,{colSpan:s.length,className:"h-24 text-center",children:"Không có kết quả."})})})]})}),e.jsx(Le,{table:N,setPage:o,setLimit:d,totalRecords:t.total_records})]})}function as(){const{toast:s}=Se(),{user:n}=q(),t=(n==null?void 0:n.role)||"customer",o=Number(n==null?void 0:n.id)||0,[d,u]=m.useState(1),[x,l]=m.useState(10),[a,C]=m.useState(""),[h,p]=m.useState(""),[j,b]=m.useState(0),{data:g,isLoading:_,error:v}=Q({queryKey:["maintenance-requests",d,x,a,h,j,t,o],queryFn:async()=>{if(t==="customer")return M.getCustomerMaintenanceRequests(o,{page:d,limit:x,search:a,status:h});{const N=await M.getAllMaintenanceRequests({page:d,limit:x,search:a,status:h,branch_id:j});return{data:N.data.requests,pagination:N.pagination}}},staleTime:5*60*1e3,retry:2,refetchOnWindowFocus:!1});v&&s({variant:"destructive",title:"Lỗi khi tải danh sách yêu cầu bảo trì",description:v.message,duration:5e3});const r=(g==null?void 0:g.data)||[],D=(g==null?void 0:g.pagination)||{current_page:1,limit:10,total_records:0,total_pages:1};return e.jsxs(Qe,{children:[e.jsxs(_e,{fixed:!0,children:[e.jsx(Me,{}),e.jsxs("div",{className:"ml-auto flex items-center space-x-4",children:[e.jsx(Te,{}),e.jsx(De,{})]})]}),e.jsx(Fe,{children:_&&!g?e.jsx("div",{className:"flex h-full items-center justify-center",children:"Đang tải yêu cầu bảo trì..."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-2 flex flex-wrap items-center justify-between space-y-2",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold tracking-tight",children:"Danh sách Yêu cầu Bảo trì"}),e.jsx("p",{className:"text-muted-foreground",children:"Quản lý yêu cầu bảo trì."})]}),e.jsx(Ge,{})]}),e.jsx("div",{className:"-mx-4 flex-1 overflow-auto px-4 py-1 lg:flex-row lg:space-x-12 lg:space-y-0",children:e.jsx(ts,{data:r,columns:Ue,pagination:D,setPage:u,setLimit:l,setSearch:C,setStatus:p,setBranchId:b,branchId:j,search:a,status:h})})]})}),e.jsx(Ze,{page:d,limit:x,search:a,status:h,branchId:j})]})}const os=qe("/_authenticated/maintenance-requests/")({component:as});export{os as Route};
