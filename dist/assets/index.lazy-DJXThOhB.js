import{V as xe,r as j,j as e,W as se,b as ae,X as te,Y as ne,B as V,Z as le,_ as K,aD as ue,aE as L,aF as pe,aq as je,f as ye,a0 as w,z as c,a1 as A,e as ie,t as ce,a2 as k,a3 as z,a4 as X,a5 as B,a6 as O,a7 as Q,y as re,F as oe,g as T,h as _,i as S,l as D,k as F,I as q,aa as $,o as I,n as M,a8 as Ne,a9 as de,$ as he,ag as be,ah as ve,ai as fe,aj as E,ak as Ce,al as _e,am as Z,H as Se,E as Me,T as Te,J as De,M as Ie,S as Ve,s as we,v as Fe,w as ke,x as Pe,aG as Ke,c as qe}from"./index-CJ1AcNxb.js";import{D as He}from"./data-table-column-header-FtAG0BCC.js";import{u as Le,D as Ee,I as Ae,M as ze,a as Xe,f as R,b as Be,g as Oe,c as Qe,d as $e,e as Ue,h as Ge,i as Je}from"./index-BcGaQFY_.js";import{I as We}from"./IconEdit-DyWwXMJq.js";import{S as H}from"./select-dropdown-poKp0Avh.js";import{C as Ye,A as Ze,a as Re,b as es}from"./alert-bq5yZ8aI.js";import{I as ss}from"./IconPlus-DrlgcPqJ.js";/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var ee=xe("outline","file-export","IconFileExport",[["path",{d:"M14 3v4a1 1 0 0 0 1 1h4",key:"svg-0"}],["path",{d:"M11.5 21h-4.5a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v5m-5 6h7m-3 -3l3 3l-3 3",key:"svg-1"}]]);const me=se.createContext(null);function as({children:s}){const[a,l]=Le(null),[n,d]=j.useState(null),[r,m]=j.useState(null);return e.jsx(me.Provider,{value:{open:a,setOpen:l,currentRow:n,setCurrentRow:d,currentRowIndex:r,setCurrentRowIndex:m},children:s})}const U=()=>{const s=se.useContext(me);if(!s)throw new Error("useInvoices must be used within InvoicesProvider");return s};function ts({row:s}){const{setOpen:a,setCurrentRow:l,setCurrentRowIndex:n}=U(),{user:d}=ae(),r=(d==null?void 0:d.role)||"customer";return e.jsxs(te,{modal:!1,children:[e.jsx(ne,{asChild:!0,children:e.jsxs(V,{variant:"ghost",className:"flex h-8 w-8 p-0",children:[e.jsx(Ee,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Open menu"})]})}),e.jsxs(le,{align:"end",className:"w-[160px]",children:[s.original.status==="paid"?e.jsxs(K,{onClick:()=>ue(s.original.id),children:["Xuất PDF",e.jsx(ee,{size:16,className:"ml-2"})]}):e.jsxs(K,{onClick:()=>{l(s.original),n(s.index),a("view")},children:["Xem hóa đơn",e.jsx(ee,{size:16,className:"ml-2"})]}),s.original.status!=="paid"&&r!=="customer"&&e.jsxs(K,{onClick:()=>{l(s.original),n(s.index),a("edit")},children:["Chỉnh sửa",e.jsx(We,{size:16,className:"ml-2"})]}),r!=="customer"&&e.jsxs(K,{onClick:()=>{l(s.original),n(s.index),a("delete")},className:"text-red-500",children:["Xóa",e.jsx(Ae,{size:16,className:"ml-2"})]})]})]})}const ns=[{id:"select",header:({table:s})=>e.jsx("input",{type:"checkbox",checked:s.getIsAllPageRowsSelected(),onChange:a=>s.toggleAllPageRowsSelected(a.target.checked),className:"translate-y-[2px]"}),cell:({row:s})=>e.jsx("input",{type:"checkbox",checked:s.getIsSelected(),onChange:a=>s.toggleSelected(a.target.checked),className:"translate-y-[2px]"}),enableSorting:!1,enableHiding:!1,meta:{className:"w-[40px]"}},{accessorKey:"contract_id",header:"Hợp đồng",cell:({row:s})=>e.jsxs("div",{children:["HĐ# ",s.getValue("contract_id")]}),meta:{className:"text-center"}},{accessorKey:"branch_name",header:"Chi nhánh",cell:({row:s})=>e.jsx("div",{children:s.getValue("branch_name")}),meta:{className:"text-left"}},{accessorKey:"room_name",header:"Phòng",cell:({row:s})=>e.jsx("div",{children:s.getValue("room_name")}),enableHiding:!1,enableSorting:!1,meta:{className:"text-left"}},{accessorKey:"amount",header:"Số tiền",cell:({row:s})=>e.jsx("div",{children:L(s.getValue("amount"))}),meta:{className:"text-right"}},{accessorKey:"status",header:({column:s})=>e.jsx(He,{column:s,title:"Trạng thái"}),cell:({row:s})=>{const{status:a}=s.original;if(!a)return null;const l={pending:"Chờ thanh toán",paid:"Đã thanh toán",overdue:"Quá hạn"},n=pe.get(a);return e.jsx("div",{className:"text-center",children:e.jsx(je,{variant:"outline",className:ye("capitalize",n),children:l[a]||a})})},meta:{className:"text-center"},filterFn:(s,a,l)=>l.includes(s.getValue(a)),enableHiding:!1,enableSorting:!1},{accessorKey:"due_date",id:"due_date",header:"Tháng",cell:({row:s})=>{const a=new Date(s.getValue("due_date")),l=w(a,"MM/yyyy");return e.jsx("div",{children:l})},enableHiding:!1,enableSorting:!1,meta:{className:"text-center"}},{accessorKey:"created_at",header:"Ngày tạo",cell:({row:s})=>e.jsxs("div",{children:[e.jsx("div",{className:"date",children:new Date(s.getValue("created_at")).toLocaleString("vi-VN",{day:"2-digit",month:"2-digit",year:"numeric"})}),e.jsxs("div",{className:"time text-xs text-muted-foreground",children:["lúc"," ",new Date(s.getValue("created_at")).toLocaleString("vi-VN",{hour:"2-digit",minute:"2-digit",second:"2-digit"})]})]}),meta:{className:"text-center"}},{accessorKey:"payment_date",header:"Ngày thanh toán",cell:({row:s})=>e.jsx("div",{children:s.getValue("payment_date")?e.jsxs("div",{children:[e.jsx("div",{className:"date",children:new Date(s.getValue("payment_date")).toLocaleString("vi-VN",{day:"2-digit",month:"2-digit",year:"numeric"})}),e.jsxs("div",{className:"time text-xs text-muted-foreground",children:["lúc"," ",new Date(s.getValue("payment_date")).toLocaleString("vi-VN",{hour:"2-digit",minute:"2-digit",second:"2-digit"})]})]}):"N/A"}),meta:{className:"text-center"}},{id:"actions",cell:({row:s})=>e.jsx(ts,{row:s}),enableHiding:!1,meta:{className:"w-[60px]"}}];c.union([c.literal("pending"),c.literal("paid"),c.literal("overdue")]);const ls=c.object({id:c.number(),contract_id:c.number(),branch_id:c.number(),room_id:c.number(),room_name:c.string(),branch_name:c.string(),amount:c.string().transform(s=>parseFloat(s)),due_date:c.string(),status:c.enum(["pending","paid","overdue"]),created_at:c.string(),payment_date:c.string().nullable(),deleted_at:c.string().nullable(),qr_code_url:c.string().nullable(),owner_phone:c.string().nullable(),bank_details:c.array(c.object({bank_name:c.string(),account_holder:c.string(),account_number:c.string()})).nullable()}),is=c.object({branch_id:c.string().min(1,{message:"Chi nhánh là bắt buộc."}),room_id:c.string().min(1,{message:"Phòng là bắt buộc."}),amount:c.number().min(1,{message:"Số tiền là bắt buộc."}),due_date:c.string().min(1,{message:"Ngày đến hạn là bắt buộc."}),status:c.enum(["pending","paid","overdue"],{message:"Trạng thái là bắt buộc."}),isEdit:c.boolean().optional().default(!1)});c.array(ls);const cs=c.object({branch_id:c.string().min(1,{message:"Chi nhánh là bắt buộc."}),month:c.string().min(1,{message:"Tháng là bắt buộc."}),due_date:c.string().min(1,{message:"Ngày đến hạn là bắt buộc."})});function rs({open:s,onOpenChange:a,page:l,limit:n,month:d,branchId:r,branches:m,currentRow:o}){var b,G,J,W;const i=!!o,y=A(),t=ie({resolver:ce(is),defaultValues:i?{branch_id:String(o.branch_id)||"",room_id:o.room_id.toString(),amount:Number(o.amount),due_date:o.due_date.split("T")[0],status:o.status,isEdit:i}:{branch_id:r||"",room_id:"",amount:0,due_date:new Date().toISOString().split("T")[0],status:"pending",isEdit:i}}),{data:h,isLoading:u}=k({queryKey:["invoiceDetails",o==null?void 0:o.id],queryFn:()=>I.getInvoiceDetails(o.id),enabled:!!(o!=null&&o.id),staleTime:5*60*1e3}),{data:p,refetch:x}=k({queryKey:["rooms",t.watch("branch_id")],queryFn:()=>I.getAllRooms({page:1,limit:100,branchId:t.watch("branch_id")}),staleTime:5*60*1e3,enabled:!!t.watch("branch_id")}),C=(p==null?void 0:p.data)||[];j.useEffect(()=>{i||t.setValue("branch_id",r)},[r,t,i]),j.useEffect(()=>{i||t.setValue("room_id",""),t.watch("branch_id")&&x()},[t.watch("branch_id"),i,x,t]);async function v(g){var f,Y;try{if(!i)throw new Error("Chỉ hỗ trợ chỉnh sửa hóa đơn.");const P=await I.updateInvoice(o.id,{due_date:g.due_date,status:g.status}),{data:ge}=P;ge?(y.invalidateQueries({queryKey:["invoices",l,n,d,r]}),M({title:"Cập nhật thành công!"})):M({title:"Có lỗi xảy ra",description:P.message||"Không thể hoàn tất hành động",variant:"destructive"})}catch(P){M({title:"Cập nhật thất bại",description:((Y=(f=P.response)==null?void 0:f.data)==null?void 0:Y.message)||"Lỗi hệ thống, vui lòng thử lại sau",variant:"destructive"})}finally{t.reset(),a(!1)}}const N=i?w(new Date(o.due_date),"MM/yyyy"):d;return!i||!o?null:e.jsx(z,{open:s,onOpenChange:g=>{t.reset(),a(g)},children:e.jsxs(X,{className:"sm:max-w-lg",children:[e.jsxs(B,{className:"text-left",children:[e.jsx(O,{children:"Chỉnh sửa hóa đơn"}),e.jsx(Q,{children:"Chỉnh sửa hóa đơn tại đây. Nhấp vào xác nhận khi bạn hoàn tất."})]}),e.jsx(re,{className:"-mr-4 h-[29.25rem] w-full py-1 pr-4",children:e.jsx(oe,{...t,children:e.jsxs("form",{id:"invoice-form",onSubmit:t.handleSubmit(v),className:"space-y-4 p-0.5",children:[e.jsx(T,{control:t.control,name:"branch_id",render:({field:g})=>e.jsxs(_,{className:"grid grid-cols-6 items-center gap-x-4 gap-y-1 space-y-0",children:[e.jsx(S,{className:"col-span-2 text-right",children:"Chi nhánh"}),e.jsx(H,{defaultValue:g.value,onValueChange:g.onChange,placeholder:"Chọn chi nhánh",className:"col-span-4",disabled:!0,items:m.map(f=>({label:f.name,value:f.id.toString()}))}),e.jsx(D,{className:"col-span-4 col-start-3"})]})}),e.jsx(T,{control:t.control,name:"room_id",render:({field:g})=>e.jsxs(_,{className:"grid grid-cols-6 items-center gap-x-4 gap-y-1 space-y-0",children:[e.jsx(S,{className:"col-span-2 text-right",children:"Phòng"}),e.jsx(H,{defaultValue:g.value,onValueChange:g.onChange,placeholder:"Chọn phòng",className:"col-span-4",disabled:!0,items:C.map(f=>({label:f.name,value:f.id.toString()}))}),e.jsx(D,{className:"col-span-4 col-start-3"})]})}),e.jsxs(_,{className:"grid grid-cols-6 items-center gap-x-4 gap-y-1 space-y-0",children:[e.jsx(S,{className:"col-span-2 text-right",children:"Kỳ tính tiền"}),e.jsx(F,{children:e.jsx(q,{value:N,disabled:!0,className:"col-span-4"})})]}),e.jsx(T,{control:t.control,name:"amount",render:({field:g})=>e.jsxs(_,{className:"grid grid-cols-6 items-center gap-x-4 gap-y-1 space-y-0",children:[e.jsx(S,{className:"col-span-2 text-right",children:"Số tiền"}),e.jsx(F,{children:e.jsx(q,{type:"number",step:"0.01",placeholder:"0",className:"col-span-4",min:"0",value:g.value,onChange:f=>g.onChange(parseFloat(f.target.value)||0)})}),e.jsx(D,{className:"col-span-4 col-start-3"})]})}),e.jsx(T,{control:t.control,name:"due_date",render:({field:g})=>e.jsxs(_,{className:"grid grid-cols-6 items-center gap-x-4 gap-y-1 space-y-0",children:[e.jsx(S,{className:"col-span-2 text-right",children:"Ngày đến hạn"}),e.jsx(F,{children:e.jsx(q,{type:"date",className:"col-span-4",...g})}),e.jsx(D,{className:"col-span-4 col-start-3"})]})}),e.jsx(T,{control:t.control,name:"status",render:({field:g})=>e.jsxs(_,{className:"grid grid-cols-6 items-center gap-x-4 gap-y-1 space-y-0",children:[e.jsx(S,{className:"col-span-2 text-right",children:"Trạng thái"}),e.jsx(H,{defaultValue:g.value,onValueChange:g.onChange,placeholder:"Chọn trạng thái",className:"col-span-4",items:[{label:"Chờ thanh toán",value:"pending"},{label:"Đã thanh toán",value:"paid"},{label:"Quá hạn",value:"overdue"}]}),e.jsx(D,{className:"col-span-4 col-start-3"})]})}),u?e.jsx("div",{children:"Loading details..."}):(((G=(b=h==null?void 0:h.data)==null?void 0:b.details)==null?void 0:G.length)??0)>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"font-medium",children:"Chi tiết hóa đơn"}),e.jsxs("table",{className:"w-full border-collapse border",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("th",{className:"border p-2 text-left",children:"STT"}),e.jsx("th",{className:"border p-2 text-left",children:"Tên sản phẩm"}),e.jsx("th",{className:"border p-2 text-left",children:"Thành tiền"})]})}),e.jsx("tbody",{children:(W=(J=h==null?void 0:h.data)==null?void 0:J.details)==null?void 0:W.map((g,f)=>e.jsxs("tr",{children:[e.jsx("td",{className:"border p-2",children:f+1}),e.jsx("td",{className:"border p-2",children:g.description}),e.jsx("td",{className:"border p-2",children:L(g.amount)})]},f))})]})]})]})})}),e.jsxs($,{children:[e.jsx(V,{type:"submit",form:"invoice-form",children:"Xác nhận"}),e.jsx(V,{variant:"outline",onClick:()=>a(!1),children:"Đóng"})]})]})})}function os({open:s,onOpenChange:a,page:l,limit:n,month:d,branchId:r,branches:m}){const o=A(),i=ie({resolver:ce(cs),defaultValues:{branch_id:r||"",month:d||"",due_date:new Date().toISOString().split("T")[0]}});async function y(t){var h,u;try{const p=await I.createBulkInvoices({branch_id:parseInt(t.branch_id),month:t.month,due_date:t.due_date}),{data:x}=p;x?(o.invalidateQueries({queryKey:["invoices",l,n,d,r]}),M({title:"Tạo hóa đơn hàng loạt thành công!",description:`Đã tạo ${x.count} hóa đơn.`})):M({title:"Có lỗi xảy ra",description:p.message||"Không thể hoàn tất hành động",variant:"destructive"})}catch(p){M({title:"Tạo hóa đơn hàng loạt thất bại",description:((u=(h=p.response)==null?void 0:h.data)==null?void 0:u.message)||"Lỗi hệ thống, vui lòng thử lại sau",variant:"destructive"})}finally{i.reset(),a(!1)}}return e.jsx(z,{open:s,onOpenChange:t=>{i.reset(),a(t)},children:e.jsxs(X,{className:"sm:max-w-lg",children:[e.jsxs(B,{className:"text-left",children:[e.jsx(O,{children:"Tạo hóa đơn hàng loạt"}),e.jsx(Q,{children:"Tạo hóa đơn cho tất cả phòng trong chi nhánh. Nhấp vào xác nhận khi bạn hoàn tất."})]}),e.jsx(oe,{...i,children:e.jsxs("form",{id:"bulk-invoice-form",onSubmit:i.handleSubmit(y),className:"space-y-4",children:[e.jsx(T,{control:i.control,name:"branch_id",render:({field:t})=>e.jsxs(_,{className:"grid grid-cols-6 items-center gap-x-4 gap-y-1 space-y-0",children:[e.jsx(S,{className:"col-span-2 text-right",children:"Chi nhánh"}),e.jsx(H,{defaultValue:t.value,onValueChange:t.onChange,placeholder:"Chọn chi nhánh",className:"col-span-4",items:m.map(h=>({label:h.name,value:h.id.toString()}))}),e.jsx(D,{className:"col-span-4 col-start-3"})]})}),e.jsx(T,{control:i.control,name:"month",render:()=>e.jsxs(_,{className:"grid grid-cols-6 items-center gap-x-4 gap-y-1 space-y-0",children:[e.jsx(S,{className:"col-span-2 text-right",children:"Kỳ tính tiền"}),e.jsx(F,{children:e.jsx(Ne,{control:i.control,name:"month",render:({field:{onChange:t,value:h}})=>e.jsx("div",{className:"col-span-4",children:e.jsx(de,{currentMonth:h?he(h,"yyyy-MM",new Date):new Date,onMonthChange:u=>{if(u){const p=w(u,"yyyy-MM");t(p)}else t("")}})})})}),e.jsx(D,{className:"col-span-4 col-start-3"})]})}),e.jsx(T,{control:i.control,name:"due_date",render:({field:t})=>e.jsxs(_,{className:"grid grid-cols-6 items-center gap-x-4 gap-y-1 space-y-0",children:[e.jsx(S,{className:"col-span-2 text-right",children:"Ngày đến hạn"}),e.jsx(F,{children:e.jsx(q,{type:"date",className:"col-span-4",...t})}),e.jsx(D,{className:"col-span-4 col-start-3"})]})})]})}),e.jsx($,{children:e.jsx(V,{type:"submit",form:"bulk-invoice-form",children:"Xác nhận"})})]})})}function ds({open:s,onOpenChange:a,currentRow:l,page:n,limit:d,month:r,branchId:m}){const o=A();async function i(){var t,h;try{await I.deleteInvoice(l.id),o.invalidateQueries({queryKey:["invoices",n,d,r,m]}),M({title:"Xóa hóa đơn thành công!"})}catch(u){M({title:"Xóa hóa đơn thất bại",description:((h=(t=u.response)==null?void 0:t.data)==null?void 0:h.message)||"Lỗi hệ thống, vui lòng thử lại sau",variant:"destructive"})}finally{a(!1)}}const y=w(new Date(l.due_date),"MM/yyyy");return e.jsx(Ye,{open:s,onOpenChange:a,handleConfirm:i,title:"Xóa hóa đơn",desc:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{children:["Bạn chắc chắn muốn xóa hóa đơn tháng ",e.jsx("span",{className:"font-bold",children:y}),"?"]}),e.jsxs(Ze,{variant:"destructive",children:[e.jsx(Re,{children:"Cảnh báo!"}),e.jsx(es,{children:"Hành động này không thể hoàn tác."})]})]}),confirmText:"Xóa",destructive:!0})}function hs({open:s,onOpenChange:a,month:l,currentRow:n}){var y,t,h,u,p;const d=!!n,{data:r,isLoading:m}=k({queryKey:["invoiceDetails",n==null?void 0:n.id],queryFn:()=>I.getInvoiceDetails(n.id),enabled:!!(n!=null&&n.id),staleTime:5*60*1e3}),o=d?w(new Date(n.due_date),"MM/yyyy"):l,i=(y=r==null?void 0:r.data)==null?void 0:y.invoice;return!d||!n?null:e.jsx(z,{open:s,onOpenChange:x=>{a(x)},children:e.jsxs(X,{className:"sm:max-w-lg",children:[e.jsxs(B,{className:"text-left",children:[e.jsx(O,{children:"Xem hóa đơn"}),e.jsx(Q,{children:"Thông tin chi tiết hóa đơn. Nhấp vào đóng để thoát."})]}),e.jsx(re,{className:"-mr-4 h-[29.25rem] w-full py-1 pr-4",children:e.jsxs("div",{className:"space-y-4 p-0.5",children:[e.jsxs("div",{className:"grid grid-cols-6 items-center gap-x-4 gap-y-1",children:[e.jsx("label",{className:"col-span-2 text-right font-medium",children:"Chi nhánh"}),e.jsx("div",{className:"col-span-4",children:(i==null?void 0:i.branch_name)||""})]}),e.jsxs("div",{className:"grid grid-cols-6 items-center gap-x-4 gap-y-1",children:[e.jsx("label",{className:"col-span-2 text-right font-medium",children:"Phòng"}),e.jsx("div",{className:"col-span-4",children:(i==null?void 0:i.room_name)||""})]}),e.jsxs("div",{className:"grid grid-cols-6 items-center gap-x-4 gap-y-1",children:[e.jsx("label",{className:"col-span-2 text-right font-medium",children:"Kỳ tính tiền"}),e.jsx("div",{className:"col-span-4",children:o})]}),e.jsxs("div",{className:"grid grid-cols-6 items-center gap-x-4 gap-y-1",children:[e.jsx("label",{className:"col-span-2 text-right font-medium",children:"Số tiền"}),e.jsx("div",{className:"col-span-4",children:L(n.amount)})]}),e.jsxs("div",{className:"grid grid-cols-6 items-center gap-x-4 gap-y-1",children:[e.jsx("label",{className:"col-span-2 text-right font-medium",children:"Ngày đến hạn"}),e.jsx("div",{className:"col-span-4",children:n.due_date.split("T")[0]})]}),e.jsxs("div",{className:"grid grid-cols-6 items-center gap-x-4 gap-y-1",children:[e.jsx("label",{className:"col-span-2 text-right font-medium",children:"Trạng thái"}),e.jsx("div",{className:"col-span-4",children:n.status==="pending"?"Chờ thanh toán":n.status==="paid"?"Đã thanh toán":"Quá hạn"})]}),m?e.jsx("div",{children:"Loading details..."}):(((h=(t=r==null?void 0:r.data)==null?void 0:t.details)==null?void 0:h.length)??0)>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"font-medium",children:"Chi tiết hóa đơn"}),e.jsxs("table",{className:"w-full border-collapse border",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("th",{className:"border p-2 text-left",children:"STT"}),e.jsx("th",{className:"border p-2 text-left",children:"Tên sản phẩm"}),e.jsx("th",{className:"border p-2 text-left",children:"Thành tiền"})]})}),e.jsx("tbody",{children:(p=(u=r==null?void 0:r.data)==null?void 0:u.details)==null?void 0:p.map((x,C)=>e.jsxs("tr",{children:[e.jsx("td",{className:"border p-2",children:C+1}),e.jsx("td",{className:"border p-2",children:x.description}),e.jsx("td",{className:"border p-2",children:L(x.amount)})]},C))})]})]})]})}),e.jsx($,{children:e.jsx(V,{variant:"outline",onClick:()=>a(!1),children:"Đóng"})})]})})}function ms({page:s,limit:a,month:l,branchId:n,branches:d}){const{open:r,setOpen:m,currentRow:o,setCurrentRow:i}=U();return e.jsxs(e.Fragment,{children:[r==="bulk"&&e.jsx(os,{open:!0,onOpenChange:y=>m(y?"bulk":null),page:s,limit:a,month:l,branchId:n,branches:d},"invoices-bulk"),o&&e.jsxs(e.Fragment,{children:[r==="view"&&e.jsx(hs,{open:!0,onOpenChange:()=>{m(null),setTimeout(()=>{i(null)},500)},page:s,limit:a,month:l,branchId:n,branches:d,currentRow:o},`invoices-view-${o.id}`),r==="edit"&&e.jsx(rs,{open:!0,onOpenChange:()=>{m(null),setTimeout(()=>{i(null)},500)},page:s,limit:a,month:l,branchId:n,branches:d,currentRow:o},`invoices-edit-${o.id}`),r==="delete"&&e.jsx(ds,{open:r==="delete",onOpenChange:()=>{m(null),setTimeout(()=>{i(null)},500)},currentRow:o,page:s,limit:a,month:l,branchId:n},`invoices-delete-${o.id}`)]})]})}function gs(){const{setOpen:s}=U(),{user:a}=ae();return((a==null?void 0:a.role)||"customer")==="customer"?null:e.jsx("div",{className:"flex gap-2",children:e.jsxs(V,{onClick:()=>s("bulk"),className:"space-x-1",children:[e.jsx("span",{children:"Tạo hóa đơn "}),e.jsx(ss,{size:18})]})})}function xs({table:s}){return e.jsxs(te,{children:[e.jsx(ne,{asChild:!0,children:e.jsxs(V,{variant:"outline",size:"sm",className:"ml-auto hidden h-8 lg:flex",children:[e.jsx(ze,{className:"mr-2 h-4 w-4"}),"View"]})}),e.jsx(le,{align:"end",className:"w-[150px]",children:s.getAllColumns().filter(a=>typeof a.accessorFn<"u"&&a.getCanHide()).map(a=>e.jsx(be,{className:"capitalize",checked:a.getIsVisible(),onCheckedChange:l=>a.toggleVisibility(!!l),children:a.id},a.id))})]})}function us({columns:s,data:a,pagination:l,setPage:n,setLimit:d}){var C;const[r,m]=j.useState({}),[o,i]=j.useState({}),[y,t]=j.useState([]),[h,u]=j.useState([]),p=v=>{v===x.getState().pagination.pageIndex?n(v+1-1):n(v)},x=Xe({data:a,columns:s,state:{sorting:h,columnVisibility:o,rowSelection:r,columnFilters:y,pagination:{pageIndex:l.current_page-1,pageSize:l.limit}},manualPagination:!0,pageCount:l.total_pages,enableRowSelection:!0,onRowSelectionChange:m,onSortingChange:u,onColumnFiltersChange:t,onColumnVisibilityChange:i,getCoreRowModel:Je(),getFilteredRowModel:Ge(),getPaginationRowModel:Ue(),getSortedRowModel:$e(),getFacetedRowModel:Qe(),getFacetedUniqueValues:Oe()});return e.jsxs("div",{className:"space-y-4",children:[e.jsx(xs,{table:x}),e.jsx("div",{className:"rounded-md border",children:e.jsxs(ve,{children:[e.jsx(fe,{children:x.getHeaderGroups().map(v=>e.jsx(E,{className:"group/row",children:v.headers.map(N=>{var b;return e.jsx(Ce,{colSpan:N.colSpan,className:((b=N.column.columnDef.meta)==null?void 0:b.className)??"",children:N.isPlaceholder?null:R(N.column.columnDef.header,N.getContext())},N.id)})},v.id))}),e.jsx(_e,{children:(C=x.getRowModel().rows)!=null&&C.length?x.getRowModel().rows.map(v=>e.jsx(E,{"data-state":v.getIsSelected()&&"selected",className:"group/row",children:v.getVisibleCells().map(N=>{var b;return e.jsx(Z,{className:((b=N.column.columnDef.meta)==null?void 0:b.className)??"",children:R(N.column.columnDef.cell,N.getContext())},N.id)})},v.id)):e.jsx(E,{children:e.jsx(Z,{colSpan:s.length,className:"h-24 text-center",children:"Không có kết quả."})})})]})}),e.jsx(Be,{table:x,setPage:p,setLimit:d,totalRecords:l.total_records})]})}function ps(){const[s,a]=j.useState(1),[l,n]=j.useState(10),[d,r]=j.useState(w(new Date,"yyyy-MM")),[m,o]=j.useState(""),i=j.useMemo(()=>d?he(d,"yyyy-MM",new Date):new Date,[d]),{data:y}=k({queryKey:["branches"],queryFn:()=>I.getAllBranches({page:1,limit:100}),staleTime:5*60*1e3}),{data:t,isLoading:h,error:u,refetch:p}=k({queryKey:["invoices",s,l,d,m],queryFn:()=>Ke({page:s,limit:l,month:d,branch_id:m?parseInt(m):void 0}),staleTime:5*60*1e3,retry:2}),x=j.useMemo(()=>(y==null?void 0:y.data)||[],[y]),C=j.useMemo(()=>(t==null?void 0:t.data)||[],[t]),v=j.useMemo(()=>(t==null?void 0:t.pagination)||{current_page:1,limit:10,total_records:0,total_pages:1},[t]);j.useEffect(()=>{u&&M({variant:"destructive",title:"Lỗi khi tải danh sách hóa đơn",description:u.message,duration:5e3})},[u]),j.useEffect(()=>{p()},[d,m,p]);const N=b=>{b&&r(w(b,"yyyy-MM"))};return e.jsxs(as,{children:[e.jsxs(Se,{fixed:!0,children:[e.jsx(Me,{}),e.jsxs("div",{className:"ml-auto flex items-center space-x-4",children:[e.jsx(Te,{}),e.jsx(De,{})]})]}),e.jsx(Ie,{children:h&&!t?e.jsx("div",{className:"flex h-full items-center justify-center",children:"Đang tải hóa đơn..."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"mb-6 mt-4 px-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold tracking-tight",children:"Danh sách hóa đơn"}),e.jsx("p",{className:"text-muted-foreground",children:"Quản lý hóa đơn theo chi nhánh và tháng."})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx(gs,{})})]}),e.jsxs("div",{className:"flex items-center space-x-6 py-4",children:[e.jsx(de,{currentMonth:i,onMonthChange:N,disabled:!1}),e.jsxs(Ve,{onValueChange:o,value:m,children:[e.jsx(we,{className:"w-[200px]",children:e.jsx(Fe,{placeholder:"Chọn chi nhánh"})}),e.jsx(ke,{children:x.map(b=>e.jsx(Pe,{value:b.id.toString(),children:b.name},b.id))})]})]}),e.jsx("div",{className:"px-4",children:e.jsx("div",{className:"-mx-4 flex-1 overflow-auto px-4 py-2 lg:flex-row lg:space-x-12 lg:space-y-0",children:e.jsx(us,{data:C,columns:ns,pagination:v,setPage:a,setLimit:n,month:d,branchId:m})})})]})}),e.jsx(ms,{page:s,limit:l,month:d,branchId:m,branches:x})]})}const _s=qe("/_authenticated/invoices/")({component:ps});export{_s as Route};
